---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Subir Programa">
  <main id="UploadProgram">
    <h1>Agrega Tus Programas</h1>
    <form id="programForm">
      <div class="input-group">
        <input type="text" id="nombre" name="nombre" required />
        <label for="nombre">Nombre</label>
      </div>

      <div class="input-group">
        <input type="url" id="link_de_imagen" name="link_de_imagen" required />
        <label for="link_de_imagen">Link de Imagen</label>
      </div>

      <div class="input-group">
          <input
            type="url"
            id="link_de_descarga"
            name="link_de_descarga"
            required
          />
        <label for="link_de_descarga">Link de Descarga</label>
      </div>

      <div class="input-group">
          <input id="detalles" name="detalles" required></input>
          <label for="detalles">Detalles</label>
      </div>

      <button type="submit">Enviar</button>
    </form>
  </main>

  <!-- Agregamos el botÃ³n para recargar los programas -->
  <button id="reloadPrograms">Recargar Programas</button>

  <article>
    <h2>Programas destacados ðŸ‘‘</h2>
    <article id="programList" class="contenedor">
      <!-- AquÃ­ se mostrarÃ¡n los programas -->
    </article>
  </article>

  <div class="hola"></div>
</Layout>

<script type="module">
  import { neon } from "https://cdn.skypack.dev/@neondatabase/serverless";

  // Configura la conexiÃ³n a la base de datos Neon
  const sql = neon(
    "postgresql://Programs-db_owner:gt7QxJLNI4rP@ep-shrill-brook-a5j8odhx.us-east-2.aws.neon.tech/Programs-db?sslmode=require"
  );

  // Manejador del evento de envÃ­o del formulario
  document
    .getElementById("programForm")
    .addEventListener("submit", async (event) => {
      event.preventDefault(); // Evitar que el formulario recargue la pÃ¡gina

      // Obtener los valores del formulario
      const nombre = document.getElementById("nombre").value;
      const link_de_imagen = document.getElementById("link_de_imagen").value;
      const link_de_descarga =
        document.getElementById("link_de_descarga").value;
      const detalles = document.getElementById("detalles").value;

      // Realiza la consulta directamente a Neon desde el frontend
      try {
        const response = await sql`
                INSERT INTO programas (nombre, link_de_imagen, link_de_descarga, detalles)
                VALUES (${nombre}, ${link_de_imagen}, ${link_de_descarga}, ${detalles})
                RETURNING *`;

        console.log("Programa guardado:", response);
        alert("Programa guardado con Ã©xito");
        loadPrograms(); // Recargar los programas despuÃ©s de enviar
      } catch (error) {
        console.error("Error al guardar el programa:", error);
        alert("Hubo un error al guardar el programa");
      }
    });

  // FunciÃ³n para cargar y mostrar los programas en la pÃ¡gina
  async function loadPrograms() {
    try {
      const programs = await sql`SELECT * FROM programas`;
      const programList = document.getElementById("programList");

      // Limpiar la lista de programas actual
      programList.innerHTML = "";

      // Recorrer los programas y agregarlos al DOM
      programs.forEach((programa) => {
        const programDiv = document.createElement("div");
        programDiv.classList.add("div-container");

        programDiv.innerHTML = `
          <header>
            <img
              src="${programa.link_de_imagen}"
              alt="${programa.nombre}"
              onerror="this.onerror=null; this.src='https://s3.amazonaws.com/www-inside-design/uploads/2020/10/aspect-ratios-blogpost-1x1-1.png';"
            />
            <h3>
              <a
                rel="noreferrer"
                href="${programa.link_de_descarga}"
              >
                ${programa.nombre}
              </a>
            </h3>
          </header>
          <span>${programa.detalles}</span>
        `;

        programList.appendChild(programDiv);
      });
    } catch (error) {
      console.error("Error al cargar los programas:", error);
    }
  }

  // Cargar los programas cuando la pÃ¡gina se cargue por primera vez
  loadPrograms();

  // Manejador del botÃ³n de recarga
  document.getElementById("reloadPrograms").addEventListener("click", () => {
    loadPrograms();
  });
</script>

<style>
  /* Estilos personalizados */
  .hola {
    height: 200px;
  }

  main {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .contenedor {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 9px 3px;
  }

  header {
    display: flex;
    gap: 4px;
    align-items: center;
  }

  img {
    height: 32px;
    width: auto;
  }

  span {
    margin-top: 5px;
    color: var(--text-gray-color);
    width: 98%;
    display: block;
    text-wrap: pretty;
  }

  a {
    text-decoration: none;
    color: unset;
  }

  .input-group {
    margin: 20px 0;
  }

  .input-group label {
    font-size: 16px;
    color: black;
  }

  .input-group input {
    width: 100%;
    height: 40px;
    border: 2px solid #ccc;
    outline: none;
    border-radius: 5px;
  }

  button {
    margin-top: 20px;
    padding: 10px 20px;
    background-color: #007bff;
    color: white;
    border: none;
    cursor: pointer;
    border-radius: 5px;
  }

  button:hover {
    background-color: #0056b3;
  }
</style>
