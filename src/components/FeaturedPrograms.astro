---
import SearchBtn from "./Search-btn.astro";
---

<article>
  <header>
    <h2>Programas destacadosüëë</h2>
    <SearchBtn />
  </header>

  <button id="reloadButton"><img src="reload.svg" alt="" /></button>

  <article id="programList" class="contenedor">
    <!-- Los programas se cargar√°n aqu√≠ -->
  </article>
</article>

<script type="module">
  import { neon } from "https://cdn.skypack.dev/@neondatabase/serverless";

  const sql = neon(
    "postgresql://Programs-db_owner:gt7QxJLNI4rP@ep-shrill-brook-a5j8odhx.us-east-2.aws.neon.tech/Programs-db?sslmode=require"
  );

  // Funci√≥n cargar programas llamada cada vez que la p√°gina se recargue
  LoadPrograms();

  document
    .getElementById("reloadButton")
    .addEventListener("click", () => LoadPrograms());

  // Escuchar el cambio en el input para realizar la b√∫squeda sin esperar Enter
  document.querySelector("#input").addEventListener("input", async () => {
    const InputValue = document.querySelector("#input").value;

    // Evitar hacer la consulta si el campo est√° vac√≠o
    if (!InputValue.trim()) {
      LoadPrograms()
      return;
    }

    const response = await fetch("http://localhost:1234/search", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          InputValue
        }),
      });

      const programs = await response.json()

    // Comprueba si la b√∫squeda retorna alg√∫n valor
    if (await programs.length < 1) {
      document.getElementById("programList").innerHTML = `
      <article>
         <h4>No se han encontrado resultados para t√∫ b√∫squeda.</h4> 
         <p>Puede volver a cargar todos los programas con el bot√≥n *Todos los programasüöÄ*</p>
      </article>
      `;


  const article = programList.querySelector("article");
      programList.style.display = "flex";
      programList.style.width = "100%";
      programList.style.flexDirection = "column";
      programList.style.alignSelf = "center";
      programList.style.placeSelf = "center";
      programList.style.marginBottom = "20px";
      article.style.margin = "40px";

    const h4 = programList.querySelector("h4")
    h4.style.fontSize = "1.4rem"

    programList.querySelector("p").style.color = "gray"
      return;
    }

    // Actualiza el contenido del contenedor con los nuevos programas
    document.getElementById("programList").innerHTML = programs
      .map(
        (programa) => `
          <div class="div-container">
            <header>
              <img
                src="${programa.link_de_imagen}"
                alt="${programa.nombre}"
                width="32"
                height="32"
                loading="lazy"
                onerror="this.onerror=null; this.src='https://s3.amazonaws.com/www-inside-design/uploads/2020/10/aspect-ratios-blogpost-1x1-1.png';"
              />
              <h3>
                <a rel="noreferrer" target="_blank" href="${programa.link_de_descarga}">
                  ${programa.nombre}
                </a>
              </h3>
            </header>
            <span>${programa.detalles}</span>
          </div>
        `
      )
      .join("");
    makeStyles();
  });

  // Funci√≥n cargar programas
  const allPrograms = document.querySelector("#AllPrograms");
  allPrograms.addEventListener("click", () => LoadPrograms());

  async function LoadPrograms() {
  try {
    // Realizar una solicitud al backend
    const response = await fetch("http://localhost:1234/get");

    if (!response.ok) {
      throw new Error("Error al obtener los programas");
    }

    // Parsear la respuesta JSON
    const programs = await response.json();

    // Actualizar el contenido del contenedor con los nuevos programas
    document.getElementById("programList").innerHTML = programs
      .map(
        (programa) => `
          <div class="div-container">
            <header>
              <img
                src="${programa.link_de_imagen}"
                alt="${programa.nombre}"
                onerror="this.onerror=null; this.src='https://s3.amazonaws.com/www-inside-design/uploads/2020/10/aspect-ratios-blogpost-1x1-1.png';"
              />
              <h3>
                <a rel="noreferrer" href="${programa.link_de_descarga}">
                  ${programa.nombre}
                </a>
              </h3>
            </header>
            <span>${programa.detalles}</span>
          </div>
        `
      )
      .join("");

    makeStyles();
  } catch (error) {
    console.error("Error al cargar los programas:", error);
  }
}

  // Observar el ancho de la pantalla para hacer un dise√±o responsive
  function makeStyles() {
    window.addEventListener("resize", responsive);

    // Llamada incial
    responsive();

    function responsive() {
      // Conseguir el ancho de la pantalla
      const size = window.innerWidth;

      const contenedor = document.querySelector("article.contenedor");

      if (size <= 730) {
        // Pantalla menor a 730px
        contenedor.style.gridTemplateColumns = "100%";
      } else if (size <= 1200) {
        // Pantalla menor a 1200px
        contenedor.style.gridTemplateColumns = "50% 50%";
      } else {
        // Pantalla mayor a 1200px
        contenedor.style.gridTemplateColumns = "33.33% 33.33% 33.33%";
      }
    }

    const div_container = programList.querySelectorAll("div"); // Cambi√© 'ancores' a 'anchors'
    div_container.forEach((div) => {
      div.style.padding = "10px";
    });

    const h2 = document.querySelector("h2");
    h2.style.borderBottom = "2px solid var(--text-gray-color)";
    h2.style.marginBottom = "10px";

    const contenedor = document.querySelector("article.contenedor");
    contenedor.style.display = "grid";
    contenedor.style.gap = "9px 3px";

    const headers = programList.querySelectorAll("header");
    headers.forEach((header) => {
      header.style.display = "flex";
      header.style.gap = "4px";
      header.style.alignItems = "center";
    });

    const images = programList.querySelectorAll("img");
    images.forEach((img) => {
      img.style.height = "32px";
      img.style.width = "auto";
    });

    const anchors = programList.querySelectorAll("a"); // Cambi√© 'ancores' a 'anchors'
    anchors.forEach((a) => {
      a.style.textDecoration = "none"; // Aplica el estilo a los enlaces
      a.style.color = "unset"; // Define un color espec√≠fico
    });

    const spans = programList.querySelectorAll("span");
    spans.forEach((span) => {
      span.style.marginTop = "5px";
      span.style.color = "var(--text-gray-color)";
      span.style.width = "98%";
      span.style.display = "block";
      span.style.overflowWrap = "break-word";
    });
  }
</script>

<style>
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  #reloadButton {
    position: fixed;
    top: 60px;
    right: 30px;
    border: none;
    transition: 0.3s ease;
    cursor: pointer;
    transform: rotate(0deg);
    background-color: var(--background-color);
  }

  #reloadButton:hover {
    transform: rotate(90deg);
  }

  #reloadButton img {
    height: 32px;
  }
</style>
